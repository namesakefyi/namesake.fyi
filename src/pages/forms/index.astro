---
import { RiFileCheckLine, RiTimerLine } from "@remixicon/react";
import type { SanityDocument } from "@sanity/client";
import PageHeader from "@/components/PageHeader.astro";
import { type FormSlug, getFormConfig } from "@/constants/forms";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { loadQuery } from "@/sanity/lib/loadQuery";
import { formatTimeEstimate } from "@/utils/formatTimeEstimate";
import { getFormPdfMetadata } from "@/utils/getFormPdfMetadata";

const { params } = Astro.props;

const { data: forms } = await loadQuery<SanityDocument[]>({
  query: `*[_type == "form" && defined(slug)]{
    title,
    slug,
  } | order(publishDate desc)`,
  params,
});

// Get PDF metadata and step count for each form
const formsWithPdfs = await Promise.all(
  forms.map(async (form) => {
    const formSlug = form.slug.current as FormSlug;
    const config = getFormConfig(formSlug);
    const pdfs = config ? await getFormPdfMetadata(formSlug) : [];
    const stepCount = config?.steps.length ?? 0;
    const timeEstimate = formatTimeEstimate(stepCount);

    return {
      title: form.title,
      slug: form.slug,
      pdfs,
      stepCount,
      timeEstimate,
    };
  }),
);
---

<BaseLayout
  title="Forms"
  description="Namesake's guided forms can help you fill out all the name change documents you need to file."
  color="white"
>
  <PageHeader
    title="Forms"
    description="Namesake's guided forms can help you fill out all the name change documents you need to file."
  />
  <div class="forms">
    {
      formsWithPdfs.length ? (
        formsWithPdfs.map((form) => (
          <div class="form">
            <h3>
              <a href={`/forms/${form.slug.current}`}>{form.title}</a>
            </h3>
            <ul class="form-metadata">
              <li>
                <RiFileCheckLine />{" "}
                {`${form.pdfs.length} document${form.pdfs.length > 1 ? "s" : ""}`}
              </li>
              <li>
                <RiTimerLine />
                {form.timeEstimate}
              </li>
            </ul>
          </div>
        ))
      ) : (
        <p>No forms found.</p>
      )
    }
  </div>
</BaseLayout>

<style>
  .forms {
    display: grid;
    gap: var(--space-l);
    padding-block-end: var(--space-2xl);

    @media (width > 400px) {
      grid-template-columns: 1fr 1fr;
    }

    @media (width > 600px) {
      grid-template-columns: 1fr 1fr 1fr;
    }

    @media (width > 1000px) {
      grid-template-columns: 1fr 1fr 1fr 1fr;
    }
  }

  .form {
    border: 1px solid var(--border-color);
    padding: var(--space-l) var(--space-l);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    aspect-ratio: 8.5 / 11;
    box-shadow:
      5px 5px 0 -3px var(--background-color),
      5px 5px 0 -2px var(--border-color),
      10px 10px 0 -5px var(--background-color),
      10px 10px 0 -4px var(--border-color);

    h3 {
      font-size: var(--step-1);
      line-height: var(--line-height-display);

      a {
        text-decoration: none;
        color: var(--text-color);

        &:hover,
        &:focus {
          text-decoration: underline;
        }
      }
    }
  }

  .form-metadata {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
    margin: 0;
    padding-inline-start: var(--space-m);
    font-size: var(--step--2);
    list-style: none;
    padding: 0;
    margin: 0;

    li {
      display: flex;
      align-items: center;
      gap: var(--space-2xs);

      svg {
        height: 1lh;
        width: 1lh;
        flex-shrink: 0;
      }
    }
  }
</style>
