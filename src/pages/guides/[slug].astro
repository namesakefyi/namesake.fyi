---
import type { SanityDocument } from "@sanity/client";
import PortableText from "~/components/text/PortableText.astro";
import ProseLayout from "~/layouts/ProseLayout.astro";
import { extractHeadings } from "~/sanity/lib/extractHeadings";
import { loadQuery } from "~/sanity/lib/loadQuery";

const { slug } = Astro.params;

if (!slug) return Astro.redirect("/404");

const { data: guide } = await loadQuery<SanityDocument>({
  query: `*[_type == "guide" && slug.current == $slug][0]{
    _id,
    title,
    slug,
    content,
    "category": category[]->{
      _id,
      name,
    }
  }`,
  params: {
    slug,
  },
});

if (!guide) return Astro.redirect("/404");

const headings = extractHeadings(guide.content);
---

<ProseLayout title={guide.title} color="white" headings={headings}>
  <PortableText value={guide.content} />
</ProseLayout>
