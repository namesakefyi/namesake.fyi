---
import type { SanityDocument } from "@sanity/client";
import dayjs from "dayjs";
import localizedFormat from "dayjs/plugin/localizedFormat";
import utc from "dayjs/plugin/utc";
import type { BreadcrumbItem } from "@/components/Breadcrumbs.astro";
import TableOfContents from "@/components/TableOfContents.astro";
import PortableText from "@/components/text/PortableText.astro";
import ProseLayout from "@/layouts/ProseLayout.astro";
import { extractHeadings } from "@/sanity/lib/extractHeadings";
import { loadQuery } from "@/sanity/lib/loadQuery";

dayjs.extend(utc);
dayjs.extend(localizedFormat);

const { slug } = Astro.params;

if (!slug) return Astro.redirect("/404");

const { data: guide } = await loadQuery<SanityDocument>({
  query: `*[_type == "guide" && slug.current == $slug][0]{
    ...,
    content[]{
      ...,
      markDefs[]{
        ...,
        _type == "internalLink" => {
          ...,
          "reference": @.reference->{_type, slug, title}
        }
      }
    }
  }`,
  params: {
    slug,
  },
});

if (!guide) return Astro.redirect("/404");

const headings = extractHeadings(guide.content);

const breadcrumbs: BreadcrumbItem[] = [
  { label: "Namesake", href: "/" },
  { label: "Guides", href: "/guides" },
];
---

<ProseLayout
  title={guide.title}
  description={guide.description}
  annotation="box"
  breadcrumbs={breadcrumbs}
  color="white"
>
  <TableOfContents headings={headings} slot="toc" />
  <PortableText value={guide.content} />
  <div class="date-updated">
    Page last edited on {" "}
    <time datetime={guide._updatedAt}
      >{dayjs.utc(guide._updatedAt).local().format("LL [at] LT")}</time
    >.
  </div>
</ProseLayout>

<style>
  .date-updated {
    margin-block-start: var(--space-3xl);
    padding-block-start: var(--space-s);
    border-top: 0.5px solid var(--text-color);
    font-size: var(--step--1);
  }
</style>
