---
import type { SanityDocument } from "@sanity/client";
import TableOfContents from "@/components/TableOfContents.astro";
import PortableText from "@/components/text/PortableText.astro";
import ProseLayout from "@/layouts/ProseLayout.astro";
import { extractHeadings } from "@/sanity/lib/extractHeadings";
import { loadQuery } from "@/sanity/lib/loadQuery";

const { slug } = Astro.params;

if (!slug) return Astro.redirect("/404");

const { data: page } = await loadQuery<SanityDocument>({
  query: `*[_type == "page" && slug.current == $slug][0]{
    _id,
    title,
    slug,
    description,
    content,
    ogImage,
    annotation,
    color
  }`,
  params: {
    slug,
  },
});

if (!page) return Astro.redirect("/404");

const headings = extractHeadings(page.content);
---

<ProseLayout
  title={page.title}
  description={page.description}
  ogImage={page.ogImage?.asset}
  ogAlt={page.ogImage?.alt}
  annotation={page.annotation}
  color={page.color}
>
  <TableOfContents headings={headings} slot="toc" />
  <PortableText value={page.content} />
</ProseLayout>
