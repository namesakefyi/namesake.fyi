---
import { sanityClient } from "sanity:client";

const { node } = Astro.props;
const { markDef } = node;

// Check if reference is already resolved (from page query)
let destination =
  markDef.reference &&
  typeof markDef.reference === "object" &&
  "_type" in markDef.reference
    ? markDef.reference
    : null;

// If not resolved, fetch it
if (!destination) {
  const ref = markDef.reference?._ref || markDef._ref;
  console.log("Fetching ref:", ref);

  destination =
    ref &&
    (await sanityClient.fetch("*[_id == $ref]{_type, slug, title}[0]", {
      ref: ref,
    }));
}

const urlPrefixes: Record<string, string> = {
  post: "/blog",
  page: "",
  guide: "/guides",
  form: "/forms",
};

const href = destination
  ? `${urlPrefixes[destination._type] ?? ""}/${destination.slug.current}`
  : "#";
const title = destination?.title || (destination ? "" : "Broken link");
---

<a href={href} title={title}><slot /></a>
